(()=>{"use strict";let e=self;e.importScripts("/ffmpeg-core.js");class r{detectCompletion(e){"FFMPEG_END"===e&&null!==this.runResolve&&(this.runResolve(),this.runResolve=null,this.running=!1)}log(e){postMessage({type:"log",data:e}),this.detectCompletion(e)}async createCore(){try{return await createFFmpegCore({mainScriptUrlOrBlob:"/ffmpeg-core.js",printErr:e=>this.log(e),print:e=>this.log(e),locateFile:(e,r)=>e.endsWith("ffmpeg-core.wasm")?"/ffmpeg-core.wasm":e.endsWith("ffmpeg-core.worker.js")?"/ffmpeg-core.worker.js":r+e})}catch(e){if("bad memory"===e.message)throw Error("ffmpeg didn't start. #enable-webassembly-threads may not be enabled in chrome://flags. Open chrome console for more info.");throw Error("ffmpeg didn't start: "+e.message)}}async load(){return this.ffmpegCore?"ffmpeg already loaded":(this.ffmpegCore=await this.createCore(),this.ffmpegMain=this.ffmpegCore.cwrap("proxy_main","number",["number","number"]),"Loaded ffmpeg")}updateFile(e){this.videoFile=e;let r=this.ffmpegCore.FS,t=r.readdir("/");-1===t.indexOf("input")?r.mkdir("/input"):this.ffmpegCore.FS_unmount("/input"),-1===t.indexOf("output")&&r.mkdir("/output");let o=this.ffmpegCore.FS_filesystems.WORKERFS,i=new File([e],"tmpfile",{type:e.type});this.ffmpegCore.FS_mount(o,{files:[i]},"/input")}parseArgs(e){let r=this.ffmpegCore._malloc(e.length*Uint32Array.BYTES_PER_ELEMENT);return e.forEach((e,t)=>{let o=this.ffmpegCore._malloc(e.length+1);this.ffmpegCore.writeAsciiToMemory(e,o),this.ffmpegCore.setValue(r+Uint32Array.BYTES_PER_ELEMENT*t,o,"i32")}),[e.length,r]}FS(e){for(var r=arguments.length,t=Array(r>1?r-1:0),o=1;o<r;o++)t[o-1]=arguments[o];if(!this.ffmpegCore)throw Error("Failed to run command. ffmpeg isn't loaded yet");var i=null;try{i=this.ffmpegCore.FS[e](...t)}catch(r){if("readdir"===e)throw Error("ffmpeg.FS('readdir', '".concat(t[0],"') error. Check if the path exists, ex: ffmpeg.FS('readdir', '/')"));if("readFile"===e)throw Error("ffmpeg.FS('readFile', '".concat(t[0],"') error. Check if the path exists"));throw Error("Oops, something went wrong in FS operation.")}return i}async run(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];if(this.ffmpegCore){if(!this.running)return this.running=!0,new Promise(e=>{let t=[...this.defaultArgs,...r].filter(e=>0!==e.length);console.log("Run: ".concat(t.join(" "))),this.runResolve=e,this.ffmpegMain(...this.parseArgs(t))});throw Error("ffmpeg.wasm can only run one command at a time")}throw Error("Failed to run command. ffmpeg isn't loaded yet")}constructor(){this.ffmpegCore=null,this.ffmpegMain=null,this.videoFile=null,this.running=!1,this.runResolve=null,this.fileCount=0,this.defaultArgs=["./ffmpeg","-nostdin","-y"]}}let t=e=>i.FS("readdir","/output/").includes(e),o=e=>i.FS("readFile",e),i=new r;e.onmessage=async r=>{let{data:{file:s,args:n,output:a,outname:f,mimetype:l,isStream:m}}=r,p=0,g=r=>{e.postMessage({progress:r})};try{g("Initializing FFmpeg"),await i.load();try{i.FS("readFile",a)}catch(r){if(g("Loading Video Data"),i.updateFile(s),g("Running FFMpeg"),m&&setInterval(()=>{t("".concat(p+1,".mp4"))&&(e.postMessage({segment:{part:p,buffer:o("/output/".concat(p,".mp4"))}}),p++)},200),await i.run(...n),m)for(;t("".concat(p,".mp4"));)e.postMessage({segment:{part:p,buffer:o("/output/".concat(p,".mp4"))}}),p++;i.FS("readFile",a)}if(m){e.postMessage({});return}let r=i.FS("readFile",a),h=new File([r],f,{type:l});e.postMessage(h)}catch(r){console.error(r),e.postMessage({error:r})}}})(),_N_E={};