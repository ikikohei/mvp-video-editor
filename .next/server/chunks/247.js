(()=>{"use strict";let e=self;e.importScripts("/ffmpeg-core.js");class r{detectCompletion(e){"FFMPEG_END"===e&&null!==this.runResolve&&(this.runResolve(),this.runResolve=null,this.running=!1)}log(e){postMessage({type:"log",data:e}),this.detectCompletion(e)}async createCore(){try{return await createFFmpegCore({mainScriptUrlOrBlob:"/ffmpeg-core.js",printErr:e=>this.log(e),print:e=>this.log(e),locateFile:(e,r)=>e.endsWith("ffmpeg-core.wasm")?"/ffmpeg-core.wasm":e.endsWith("ffmpeg-core.worker.js")?"/ffmpeg-core.worker.js":r+e})}catch(e){if("bad memory"===e.message)throw Error("ffmpeg didn't start. #enable-webassembly-threads may not be enabled in chrome://flags. Open chrome console for more info.");throw Error("ffmpeg didn't start: "+e.message)}}async load(){return this.ffmpegCore?"ffmpeg already loaded":(this.ffmpegCore=await this.createCore(),this.ffmpegMain=this.ffmpegCore.cwrap("proxy_main","number",["number","number"]),"Loaded ffmpeg")}updateFile(e){this.videoFile=e;let r=this.ffmpegCore.FS,t=r.readdir("/");-1===t.indexOf("input")?r.mkdir("/input"):this.ffmpegCore.FS_unmount("/input"),-1===t.indexOf("output")&&r.mkdir("/output");let i=this.ffmpegCore.FS_filesystems.WORKERFS,o=new File([e],"tmpfile",{type:e.type});this.ffmpegCore.FS_mount(i,{files:[o]},"/input")}parseArgs(e){let r=this.ffmpegCore._malloc(e.length*Uint32Array.BYTES_PER_ELEMENT);return e.forEach((e,t)=>{let i=this.ffmpegCore._malloc(e.length+1);this.ffmpegCore.writeAsciiToMemory(e,i),this.ffmpegCore.setValue(r+Uint32Array.BYTES_PER_ELEMENT*t,i,"i32")}),[e.length,r]}FS(e,...r){if(!this.ffmpegCore)throw Error("Failed to run command. ffmpeg isn't loaded yet");var t=null;try{t=this.ffmpegCore.FS[e](...r)}catch(t){if("readdir"===e)throw Error(`ffmpeg.FS('readdir', '${r[0]}') error. Check if the path exists, ex: ffmpeg.FS('readdir', '/')`);if("readFile"===e)throw Error(`ffmpeg.FS('readFile', '${r[0]}') error. Check if the path exists`);throw Error("Oops, something went wrong in FS operation.")}return t}async run(...e){if(this.ffmpegCore){if(!this.running)return this.running=!0,new Promise(r=>{let t=[...this.defaultArgs,...e].filter(e=>0!==e.length);console.log(`Run: ${t.join(" ")}`),this.runResolve=r,this.ffmpegMain(...this.parseArgs(t))});throw Error("ffmpeg.wasm can only run one command at a time")}throw Error("Failed to run command. ffmpeg isn't loaded yet")}constructor(){this.ffmpegCore=null,this.ffmpegMain=null,this.videoFile=null,this.running=!1,this.runResolve=null,this.fileCount=0,this.defaultArgs=["./ffmpeg","-nostdin","-y"]}}let t=e=>o.FS("readdir","/output/").includes(e),i=e=>o.FS("readFile",e),o=new r;e.onmessage=async({data:{file:r,args:s,output:n,outname:a,mimetype:f,isStream:l}})=>{let m=0,p=r=>{e.postMessage({progress:r})};try{p("Initializing FFmpeg"),await o.load();try{o.FS("readFile",n)}catch{if(p("Loading Video Data"),o.updateFile(r),p("Running FFMpeg"),l&&setInterval(()=>{t(`${m+1}.mp4`)&&(e.postMessage({segment:{part:m,buffer:i(`/output/${m}.mp4`)}}),m++)},200),await o.run(...s),l)for(;t(`${m}.mp4`);)e.postMessage({segment:{part:m,buffer:i(`/output/${m}.mp4`)}}),m++;o.FS("readFile",n)}if(l){e.postMessage({});return}let g=o.FS("readFile",n),h=new File([g],a,{type:f});e.postMessage(h)}catch(r){console.error(r),e.postMessage({error:r})}},module.exports={}})();